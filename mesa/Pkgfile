# Description: Mesa 3D Graphics Library
# URL: https://www.mesa3d.org/
# Maintainer: CRUX Xorg Team, xorg-ports at crux dot nu
# Depends on: elfutils glslang libdrm libglvnd llvm python3-mako xorg-libxdamage xorg-libxrandr xorg-libxshmfence xorg-libxvmc xorg-libxxf86vm
# Optional: libva libvdpau wayland-protocols

name=mesa
version=22.3.0
release=1
source=(https://archive.mesa3d.org/$name-$version.tar.xz)

build() {
	prt-get isinst vulkan-loader && PKGMK_MESA_GALLIUM+='zink,'
	prt-get isinst libvdpau && PKGMK_MESA+=' -D gallium-vdpau=enabled' || PKGMK_MESA+=' -D gallium-vdpau=disabled'
	prt-get isinst wayland-protocols && PKGMK_MESA_PLATFORMS+='wayland'
	## for future references
	#prt-get isinst xorg-libxdamage xorg-libxrandr xorg-libxshmfence xorg-libxvmc xorg-libxxf86vm && PKGMK_MESA_PLATFORMS+=',x11'
	PKGMK_MESA_PLATFORMS+=',x11'

#	CFLAGS+=' -mtls-dialect=gnu'
#	CXXFLAGS+=' -mtls-dialect=gnu'


	CC=clang CXX=clang++ meson setup build mesa-$version $PKGMK_MESA \
		--prefix=/usr \
		--sysconfdir=/etc \
		--buildtype=plain \
		--wrap-mode nodownload \
		-D b_pie=true \
		-D dri3=enabled \
		-D egl=enabled \
		-D llvm=enabled \
		-D shared-llvm=enabled \
		-D gbm=enabled \
		-D gles1=disabled \
		-D gles2=enabled \
		-D glx=dri \
		-D osmesa=true \
		-D gallium-xa=enabled \
		-D gallium-opencl=icd \
		-D gallium-drivers=${PKGMK_MESA_GALLIUM}crocus,iris,nouveau,r300,r600,radeonsi,svga,swrast,virgl \
		-D platforms=${PKGMK_MESA_PLATFORMS#,} \
		-D shared-glapi=enabled \
		-D vulkan-drivers=amd,intel \
		-D vulkan-layers=device-select,intel-nullhw,overlay \
		-D video-codecs=vc1dec,h264dec,h264enc,h265dec,h265enc \
		-D glvnd=true

	meson compile -C build -j ${JOBS:-1}
	DESTDIR=$PKG meson install -C build

	# indirect rendering symlink
	ln -s libGLX_mesa.so.0 $PKG/usr/lib/libGLX_indirect.so.0
}
